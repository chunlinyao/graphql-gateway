# agents.md

本文件规定：在本仓库中，自动化开发代理（统称 **codex**）如何协同工作、如何领取与交付任务、如何记录决策与问题。
**注意**：本规则与任何具体实现技术栈、目录结构、代码架构无关。

---

## 1) 目标与范围

* 目标：按照 `todos.md` 的待办清单，稳定、可追溯地推进项目，从任务到可用成果的闭环。
* 范围：任务规划、实现、评审、验证、文档与变更记录的流程与交接规范。

---

## 2) 术语

* **任务（Task）**：`todos.md` 中的一条待办项。
* **状态（Status）**：`todo` → `in-progress` → `review` → `done`（或 `blocked`）。
* **产物（Artifact）**：代码、配置、脚本、文档、测试、构建产物等。
* **决策记录（Decision）**：对需求/设计/实现做出的显著取舍，需留下文字记录。

---

## 3) 角色（Agents）与职责

> 同一个 codex 可在不同阶段切换角色；每次切换必须按第 5 节的交接规范完成。

1. **Planner（规划）**

   * 从 `todos.md` 选择最高优先级且未被占用的任务，创建/细化子任务。
   * 澄清需求：若有不确定性，新增「Open Questions」并标记对应任务为 `blocked`。

2. **Implementer（实现）**

   * 在 `in-progress` 任务下开展实现，生成最小可用产物。
   * 同步记录实现要点与边界（见第 6 节产物与日志）。

3. **Reviewer（评审）**

   * 对处于 `review` 的任务进行形式检查（完整性、可读性、异常场景、边界条件）。
   * 发现问题则退回 `in-progress` 并给出具体改进点。

4. **Verifier（验证/QA）**

   * 针对任务的验收标准执行验证（自测脚本、样例输入输出、结果比对）。
   * 验证通过将任务置为 `done`，失败则回退 `in-progress` 并附复现步骤。

5. **Documenter（文档）**

   * 为完成的任务补全必要文档（使用说明、运行方式、已知限制）。
   * 同步更新 `todos.md` 的「Notes/Follow-ups」。

6. **Maintainer（维护）**

   * 管理 `todos.md` 的优先级、合并重复任务、关闭无效或过时任务。
   * 监督变更记录与决策记录是否完整。

---

## 4) 任务生命周期（状态机）

* **todo**：候选任务，尚未被领取。
* **in-progress**：已领取，正在实现。
* **review**：实现完成，等待评审。
* **done**：评审与验证通过。
* **blocked**：因依赖/信息缺失无法推进；需要 Planner 或 Maintainer 介入。

**状态转换规则**

* `todo → in-progress`：Implementer 领取任务并在 `todos.md` 标注领取者与时间戳。
* `in-progress → review`：提交实现与验证材料后，变更状态。
* `review → in-progress`：Reviewer 指出问题并给出操作性建议。
* `review → done`：Reviewer + Verifier 通过后，置为完成。
* 任意状态 → `blocked`：信息缺失/外部依赖未就绪；需记录阻塞原因与所需信息。

---

## 5) 交接规范（角色切换时的必做项）

每次把任务交给下一角色时，**必须**在 `todos.md` 的该任务条目里补齐以下字段：

* **Context**：本次工作做了什么、为什么这样做（简要）。
* **What Changed**：具体改动点（文件/模块/接口/脚本等，尽量可定位）。
* **How to Run/Test**：如何运行/验证（命令、输入、期望输出）。
* **Known Limits**：当前已知限制与风险。
* **Next Role**：下一处理角色与建议关注点。

---

## 6) 产物与记录要求

为保证可追溯与可复现，任何完成到 `review` 的任务，需在该任务下提供：

* **变更清单**：本次变更涉及的主要文件/脚本/配置名称与作用简述。
* **运行说明**：最少一条可复制的运行/验证步骤（命令+参数或伪指令）。
* **示例数据**：如涉及输入输出，提供最小样例与期望结果。
* **错误处理**：说明主要异常路径与降级/报错策略。
* **后续工作**：遗留问题或建议的后续 todo（可转化为子任务）。

> 不要求固定目录或技术栈；但要求信息充分，使后续角色**不依赖外部口述**可继续推进。

---

## 7) 变更与决策管理

* **决策记录**：新增或修改重要规则/取舍时，在 `docs/decisions/`（或任意文档区）新增一条记录，命名建议：`YYYYMMDD-short-slug.md`。内容包括：背景、选项、取舍、影响与回滚方式。
* **范围变更**：如任务范围变化或合并，需更新 `todos.md` 对应条目的描述与验收标准。
* **撤销/回滚**：如需撤销改动，需在任务下写明回滚原因与影响面。

> 文档目录名不做强制要求；只需保证记录**存在并可追溯**。

---

## 8) 质量门槛（适用于所有任务）

* **可运行/可验证**：必须给出最小可运行或可验证的步骤。
* **可读性**：命名清晰、注释必要、关键逻辑有说明。
* **一致性**：与同仓已有约定保持一致（命令、参数、术语）。
* **最少惊讶原则**：默认行为符合直觉；非直觉之处需显式说明。
* **安全与密钥**：禁止提交任何敏感密钥；如需凭据，使用占位与说明。
* **可恢复**：失败时应可回滚或快速恢复（提供说明）。

---

## 9) 沟通与提问

* 若任务信息不足：

  * 在 `todos.md` 的任务下添加「Open Questions」子段，列出问题与所需信息；
  * 将状态置为 `blocked`，并简述阻塞原因。
* 不通过外部口头沟通解决关键问题；一律在仓库文档中落档。

---

## 10) 提交与记录（通用约定）

* 每次推进，更新对应任务条目的**状态、说明与时间戳**。
* 提交信息（commit/记录文本）建议采用前缀：

  * `feat:` 新增能力
  * `fix:` 修复缺陷
  * `docs:` 文档与说明
  * `chore:` 其他维护性改动
* 若无版本控制场景，可在任务条目中用「Change Log」小节代替。

---

## 11) 验收（Definition of Done）

一条任务满足以下条件方可标记 `done`：

1. `todos.md` 状态为 `done`，并包含第 5、6 节要求的信息；
2. 运行/验证步骤按描述可复现；
3. 相关决策（如有）已在文档中登记；
4. 无未解释的严重问题；
5. 如产生后续事项，已在 `todos.md` 建立后续子任务或备注。

---

## 12) 失败与回滚

* 若实施失败或引入严重问题：

  * 立即标记任务为 `in-progress` 或 `blocked`，说明原因；
  * 补充「回滚操作」或「临时规避方案」；
  * 由 Planner/ Maintainer 评估是否拆分为更小任务重做。

---

## 13) 附：最小任务模板（可直接复制到 `todos.md`）

```markdown
- [ ] <任务标题>  (status: todo | in-progress | review | done | blocked)
  - Owner: <codex/人名>  @ <YYYY-MM-DD HH:mm>
  - Context:
  - Acceptance:
  - Steps/Plan:
  - What Changed:
  - How to Run/Test:
  - Known Limits:
  - Open Questions:
  - Next Role:
  - Notes/Follow-ups:
```
